---
import ProtectedLayout from "@/layouts/protected-layout.astro";
import Sudoku from "@/games/sudoku.astro";
import Wordle from "@/games/wordle.astro";
import MemoryGame from "@/games/memory-game.astro";
import TowerHanoi from "@/games/tower-hanoi.astro";
---

<ProtectedLayout>
  <div
    class="flex flex-col items-center justify-center h-auto text-white gap-4"
  >
    <!-- Controls -->
    <div class="flex gap-4 mt-6 w-full justify-around items-center">
      <button
        id="prev-btn"
        class="rounded-xl bg-gray-800 px-5 py-2 font-semibold text-gray-200 hover:bg-gray-700 active:scale-95 transition"
      >
        ⬅ Prev
      </button>
      <button
        id="next-btn"
        class="rounded-xl bg-indigo-600 px-5 py-2 font-semibold text-white hover:bg-indigo-500 active:scale-95 transition"
      >
        Next ➡
      </button>
    </div>

    <!-- Game Container -->
    <div
      id="game-container"
      class="relative w-full max-w-8xl rounded-2xl min-h-[700px] p-6 shadow-lg overflow-auto border"
    >
      <div
        class="game opacity-100 h-full w-full flex justify-center items-center absolute inset-0"
        id="game-0"
      >
        <TowerHanoi />
      </div>
      <div
        class="game opacity-0 h-full w-full flex justify-center items-center absolute inset-0"
        id="game-1"
      >
        <Sudoku />
      </div>
      <div
        class="game opacity-0 h-full w-full flex justify-center items-center absolute inset-0"
        id="game-2"
      >
        <MemoryGame />
      </div>
      <div
        class="game opacity-0 h-full w-full flex justify-center items-center absolute inset-0"
        id="game-3"
      >
        <Wordle />
      </div>
    </div>
  </div>

  <!-- JS Logic -->
  <script>
    import { incrementSudokuTimer, sudokuStore } from "@/store/sudoku.store";
    import { incrementTowerTimer, towerStore } from "@/store/tower.store";
    import { resetTimer, timer } from "@/store/timer.store";
    import { incrementMemoryTimer, memoryStore } from "@/store/memory.store";
    import { incrementWordleTimer, wordleStore } from "@/store/wordle.store";

    document.addEventListener("DOMContentLoaded", () => {
      const games = document.querySelectorAll(".game");
      let current = 0;
      let activeGameIndex = null;

      // Modular game handlers per game index
      const gameHandlers = [
        {
          onOpen: () => {
            // Tower Hanoi open logic (add if needed)
            const toStore = towerStore.get();
            if (toStore.status === "won" || toStore.status == "lost") {
              alert("Tower already played");
            } else {
              // Start Sudoku interval
              window.towerInterval = setInterval(() => {
                incrementTowerTimer();
              }, 1000);
            }
          },
          onClose: () => {
            // Tower Hanoi close logic (add if needed)
            if (window.towerInterval) {
              clearInterval(window.towerInterval);
              window.towerInterval = null;
            }
          },
        },
        {
          onOpen: () => {
            // check if sudoku already played
            const suStore = sudokuStore.get();
            if (suStore.status === "won" || suStore.status == "lost") {
              alert("Sudoku already played");
            } else {
              // Start Sudoku interval
              window.sudokuInterval = setInterval(() => {
                incrementSudokuTimer();
              }, 1000);
            }
          },
          onClose: () => {
            // Clear Sudoku interval
            if (window.sudokuInterval) {
              clearInterval(window.sudokuInterval);
              window.sudokuInterval = null;
            }
          },
        },
        {
          onOpen: () => {
            // Memory Game open logic (add if needed)
            const memStore = memoryStore.get();
            if (memStore.status === "won" || memStore.status == "lost") {
              alert("Memory Game already played");
            } else {
              // Start Sudoku interval
              window.memoryInterval = setInterval(() => {
                incrementMemoryTimer();
              }, 1000);
            }
          },
          onClose: () => {
            // Memory Game close logic (add if needed)
            if (window.memoryInterval) {
              clearInterval(window.memoryInterval);
              window.memoryInterval = null;
            }
          },
        },
        {
          onOpen: () => {
            // Wordle open logic (add if needed)
            const woStore = wordleStore.get();
            if (woStore.status === "won" || woStore.status == "lost") {
              alert("Tower already played");
            } else {
              // Start Sudoku interval
              window.wordleInterval = setInterval(() => {
                incrementWordleTimer();
              }, 1000);
            }
          },
          onClose: () => {
            // Wordle close logic (add if needed)
            if (window.wordleInterval) {
              clearInterval(window.wordleInterval);
              window.wordleInterval = null;
            }
          },
        },
      ];

      timer.subscribe((time) => {
        if (time === 0) {
          resetTimer();
          window.location.href = "/result";
        }
      });

      const showGame = (index) => {
        // Close previous game if any
        if (
          activeGameIndex !== null &&
          gameHandlers[activeGameIndex]?.onClose
        ) {
          gameHandlers[activeGameIndex].onClose();
        }

        // Show/hide games
        games.forEach((g, i) => {
          if (i === index) {
            g.classList.remove("opacity-0", "pointer-events-none");
            g.classList.add("opacity-100");
          } else {
            g.classList.add("opacity-0", "pointer-events-none");
            g.classList.remove("opacity-100");
          }
        });

        // Open current game
        if (gameHandlers[index]?.onOpen) {
          gameHandlers[index].onOpen();
        }

        activeGameIndex = index;
      };

      // Initially show first game and trigger open handler
      showGame(current);

      const nextBtn = document.getElementById("next-btn");
      const prevBtn = document.getElementById("prev-btn");
      if (!nextBtn || !prevBtn) return;

      nextBtn.addEventListener("click", () => {
        current = (current + 1) % games.length;
        showGame(current);
      });

      prevBtn.addEventListener("click", () => {
        if (current === 0) return;
        current = (current - 1 + games.length) % games.length;
        showGame(current);
      });
    });
  </script>

  <style>
    .game {
      transition: opacity 0.4s ease-in-out;
    }
  </style>
</ProtectedLayout>
